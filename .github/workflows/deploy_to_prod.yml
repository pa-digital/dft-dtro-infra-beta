name: Deploy to Production

on:
  push:
    tags:
      - *

env:
  SNOWSQL_PWD: ${{ secrets.SNOWFLAKE_PASSWORD }}
  SNOWSQL_USR: ${{ secrets.SNOWFLAKE_USER }}
  SNOWSQL_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
jobs:
  wait-for-approval:
     name: Wait for approval
     runs-on: ubuntu-latest
     steps:
        - name: Extract Release Version
          id: targetenv
          run: |
            echo "Extracting release version..."
            echo "github.ref is ${{github.ref}}"
            original_string=${{github.ref}}
            release="${original_string#refs/tags/}"
            echo "release is ${release}"
            echo "RELEASE=${release}" >> "$GITHUB_OUTPUT"

        - name: Create GitHub issue
          uses: trstringer/manual-approval@v1
          with:
            secret: ${{ github.TOKEN }}
            approvers: VinP-PA
            minimum-approvals: 1
            issue-title: "Deploying ${{steps.targetenv.outputs.RELEASE}} to Prod"
            issue-body: "Approving this issue will deploy release version: ${{steps.targetenv.outputs.RELEASE}} to the Production environment."
            exclude-workflow-initiator-as-approver: false #TODO: Must be set to true

#  terraform-deploy-production:
#    name: Terraform - Deploy to Production
#    uses: ./.github/workflows/deploy_resources.yml
#    needs:
#      - wait-for-approval
#    secrets:
#      workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
#      wip_service_account: ${{ secrets.WIP_SERVICE_ACCOUNT }}
#      execution_service_account: ${{ secrets.EXECUTION_SERVICE_ACCOUNT }}
#      dft_organisation: ${{ secrets.DFT_ORGANISATION }}
#      dft_organisation_id: ${{ secrets.DFT_ORGANISATION_ID }}
#      access_level_members: ${{ secrets.ACCESS_LEVEL_MEMBERS }}
#    with:
#      gcp-project-id: ${{ vars.GCP_PROJECT_ID_DEV }}
#      gcp-region: ${{ vars.DEFAULT_GCP_REGION }}
#      environment: dev
#      run-terraform: true
#      run-apigee: false #TODO: Default value when no major endpoint or OAuth changes have been made
  #      run-apigee: true
#    secrets:
#      workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER_PROD }}
#      wip_service_account: ${{ secrets.WIP_SERVICE_ACCOUNT_PROD }}
#      execution_service_account: ${{ secrets.EXECUTION_SERVICE_ACCOUNT_PROD }}
#      dft_organisation: ${{ secrets.DFT_ORGANISATION }}
#      dft_organisation_id: ${{ secrets.DFT_ORGANISATION_ID }}
#      access_level_members: ${{ secrets.ACCESS_LEVEL_MEMBERS }}
#    with:
#      gcp-project-id: ${{ vars.GCP_PROJECT_ID_PROD }}
#      gcp-region: ${{ vars.DEFAULT_GCP_REGION }}
#      environment: dev
#      run-terraform: true
#      run-apigee: false #TODO: Default value when no major endpoint or OAuth changes have been made
#  #      run-apigee: true